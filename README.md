# URL Shortener Backend with AWS CDK

This project contains the backend for a URL shortener. It uses AWS CDK to
provision the required AWS resources. The backend is serverless without 
using AWS Lambda, only using AWS API Gateway with AWS Integrations and 
AWS DynamoDB.


## Endpoints
- `GET /{shortId}` Redirects to the long URL

- `DELETE /{shortId}` Deletes a short URL **(*)**

- `GET /shortened-urls` Lists all short URLs **(*)**

- `POST /shortened-urls` Creates a new short URL **(*)**
```json
{
    "shortId": "gg",
    "url": "https://www.google.com"
}
```

**(*) Requires an API Key (Headers: `x-api-key`)**

## Authorization

The API is protected with an API Key. The API Key is passed in the `x-api-key`
header. The API Key is generated by the admin user. 

Example Headers: 
```
x-api-key: "1234567890"
```

## Virtual Environment
### Setup Virtual Environment

This project is set up like a standard Python project. The initialization
process also creates a virtualenv within this project, stored under the `.venv`
directory. To create the virtualenv it assumes that there is a `python3`
(or `python` for Windows) executable in your path with access to the `venv`
package. If for any reason the automatic creation of the virtualenv fails,
you can create the virtualenv manually.

To manually create a virtualenv on MacOS and Linux:

```
python3 -m venv .venv
```

After the init process completes and the virtualenv is created, you can use the
following
step to activate your virtualenv.

```
source .venv/bin/activate
```

If you are a Windows platform, you would activate the virtualenv like this:

```
% .venv\Scripts\activate.bat
```

Once the virtualenv is activated, you can install the required dependencies.

```
pip install -r requirements.txt
```

At this point you can now synthesize the CloudFormation template for this code.

```
cdk synth
```

To add additional dependencies, for example other CDK libraries, just add
them to your `setup.py` file and rerun the `pip install -r requirements.txt`
command.

### Useful commands

* `cdk ls`          list all stacks in the app
* `cdk synth`       emits the synthesized CloudFormation template
* `cdk deploy`      deploy this stack to your default AWS account/region
* `cdk diff`        compare deployed stack with current state
* `cdk docs`        open CDK documentation

Enjoy!

## Project setup

Initialize the CDK project

```
cdk init app --language=python
```

After activating the virtual environment, install the CDK dependencies

```
pip install -r requirements.txt
```

## Manual Deployment

Prerequisites:
- AWS CLI installed and configured 
- AWS CDK installed (`npm install -g aws-cdk`)

Before deploying the stack, you need to bootstrap the environment. 
You can configure the default account and region by running `aws configure`. 
You can also specify the account and region by running `cdk deploy --profile <profile>`.

```
cdk bootstrap
```

Deploy the stack to your default AWS account/region. 

```
cdk deploy
```

Destroy the stack

```
cdk destroy
```

## Automatic Deployment

The stack is automatically deployed with GitHub Actions. The workflow is
triggered on every push to the `main` branch. The workflow is defined in
`.github/workflows/cdk-deploy.yml`.

## References

- https://aws.amazon.com/blogs/compute/building-a-serverless-url-shortener-app-without-lambda-part-1/
- https://aws.amazon.com/blogs/compute/building-a-serverless-url-shortener-app-without-lambda-part-2/
- https://aws.amazon.com/blogs/compute/building-a-serverless-url-shortener-app-without-lambda-part-3/